<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Auto Image Compressor</title>
    <link rel="icon" href="https://shawkui.github.io/images/favicon-96x96.png?v=M44lzPylqQ" type="image/png">

    <style>
        :root {
            --bg-color: #f5f5f5;
            --text-color: #333;
            --accent-color: #0080ff;
            --accent-hover: #0066cc;
            --accent-active: #004d99;
            --border-color: #ccc;
            --success-color: #28a745;
        }

        body {
            background: var(--bg-color);
            font-family: monospace;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            color: var(--text-color);
        }

        header, footer {
            background: var(--text-color);
            color: white;
            padding: 15px;
            text-align: center;
        }

        header h1 { margin: 0; font-size: 1.8em; }

        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 20px;
        }

        .tool-card {
            background: white;
            width: 100%;
            max-width: 850px;
            padding: 30px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        .config-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px dashed var(--border-color);
        }

        .input-group { display: flex; flex-direction: column; gap: 8px; }
        .input-group label { font-weight: bold; font-size: 0.9em; }

        input[type="number"], select, input[type="file"] {
            padding: 8px;
            font-family: monospace;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            outline: none;
        }

        .btn {
            background: var(--accent-color);
            color: white;
            cursor: pointer;
            font-size: 1.1em;
            font-family: monospace;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            transition: background 0.2s ease-in-out;
            width: 100%;
        }
        .btn:hover { background: var(--accent-hover); }
        .btn:disabled { background: #ccc; cursor: not-allowed; }

        /* Report Table */
        #report {
            margin-top: 30px;
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }
        #report th { text-align: left; border-bottom: 2px solid var(--text-color); padding: 10px; }
        #report td { padding: 10px; border-bottom: 1px solid #eee; }

        .status-badge {
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 0.85em;
        }
        .status-working { background: #fff3cd; color: #856404; }
        .status-done { background: #d4edda; color: #155724; }
        .status-skip { background: #e2e3e5; color: #383d41; }

        .download-link { color: var(--accent-color); text-decoration: none; font-weight: bold; }
        #batch-download-btn { margin-top: 20px; background: var(--success-color); display: none; }

        /* Instructions Section */
        .instructions {
            margin-top: 40px;
            padding: 20px;
            background: #fafafa;
            border: 1px solid #eee;
            border-radius: 8px;
            font-size: 0.9em;
        }
        .instructions h3 { margin-top: 0; color: var(--accent-color); border-bottom: 1px solid #ddd; padding-bottom: 5px; }
        .instructions ul { padding-left: 20px; line-height: 1.6; }
        .instructions li { margin-bottom: 10px; }
        .note { color: #666; font-size: 0.85em; border-left: 3px solid var(--accent-color); padding-left: 10px; margin-top: 15px; }

        footer a { color: white; text-decoration: underline; }
    </style>
</head>

<body>
    <header>
        <h1>Image Compressor</h1>
    </header>

    <main>
        <div class="tool-card">
            <div class="config-section">
                <div class="input-group">
                    <label>Target Size (KB)</label>
                    <input type="number" id="targetSize" value="512" min="1">
                </div>
                <div class="input-group">
                    <label>Strategy</label>
                    <select id="strategyMode">
                        <option value="auto">Smart Heuristic</option>
                        <option value="manual">Manual Start</option>
                    </select>
                </div>
                <div class="input-group" id="manualQualityGroup" style="display:none;">
                    <label>Initial Quality (0.1-1.0)</label>
                    <input type="number" id="manualQuality" value="0.9" step="0.1" min="0.1" max="1.0">
                </div>
                <div class="input-group">
                    <label>Select Images</label>
                    <input type="file" id="fileInput" accept="image/jpeg,image/png" multiple>
                </div>
            </div>

            <button id="processBtn" class="btn">Compress Images</button>

            <table id="report" style="display: none;">
                <thead>
                    <tr>
                        <th>Filename</th>
                        <th>Original</th>
                        <th>Result</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="fileList"></tbody>
            </table>

            <button id="batch-download-btn" class="btn" onclick="downloadAll()">Download All Compressed Images</button>

            <div class="instructions">
                <h3>How to Use</h3>
                <ul>
                    <li><strong>1. Upload:</strong> Click "Select Images" to choose one or more JPG/PNG files from your device.</li>
                    <li><strong>2. Set Target:</strong> Input your desired file size in <strong>KB</strong> (e.g., 512). The tool will attempt to get as close as possible to this limit without exceeding it significantly.</li>
                    <li><strong>3. Choose Strategy:</strong> 
                        <br>• <em>Smart Heuristic:</em> Automatically detects image density to preserve maximum quality.
                        <br>• <em>Manual Start:</em> Allows you to define the starting quality point for the compression algorithm.
                    </li>
                    <li><strong>4. Compress:</strong> Click the "Compress Images" button. The tool uses a <strong>binary search algorithm</strong> to iteratively find the perfect balance between size and quality.</li>
                    <li><strong>5. Download:</strong> Save files individually from the table or use the green button to save all results at once.</li>
                </ul>
                <div class="note">
                    <strong>Privacy Notice:</strong> This is a 100% Client-Side tool. Your images are processed entirely within your browser's memory. No data is uploaded to any server.
                </div>
            </div>
        </div>
    </main>

    <div class="clustrmap" style="width: 300pt; margin: 20px auto;">
        <h2 style="text-align: center; font-size: 1em;">Visitor Map</h2>
        <script type="text/javascript" id="clustrmaps"
            src="//clustrmaps.com/map_v2.js?d=CgXNcTnngetrL0Ic-6fP1VQ_yyK1aaSZsr1PV-_sVfY&cl=ffffff&w=a"></script>
    </div>

    <footer>
        <p>Image Compressor by Shaokui Wei, <a href="https://shawkui.github.io/">https://shawkui.github.io</a>, 2024</p>
    </footer>

    <script>
        // JS remains the same as previous functional version
        const fileInput = document.getElementById('fileInput');
        const targetSizeInput = document.getElementById('targetSize');
        const strategyMode = document.getElementById('strategyMode');
        const manualQualityGroup = document.getElementById('manualQualityGroup');
        const processBtn = document.getElementById('processBtn');
        const reportTable = document.getElementById('report');
        const fileList = document.getElementById('fileList');
        const batchBtn = document.getElementById('batch-download-btn');

        let downloadQueue = [];

        strategyMode.onchange = () => {
            manualQualityGroup.style.display = strategyMode.value === 'manual' ? 'flex' : 'none';
        };

        processBtn.onclick = async () => {
            const files = Array.from(fileInput.files);
            const targetKB = parseFloat(targetSizeInput.value);
            if (!files.length) return alert('Please select images first.');

            fileList.innerHTML = '';
            reportTable.style.display = 'table';
            batchBtn.style.display = 'none';
            downloadQueue = [];
            processBtn.disabled = true;

            for (const file of files) {
                const row = createRow(file);
                fileList.appendChild(row);
                const originalKB = file.size / 1024;

                if (originalKB <= targetKB) {
                    const url = URL.createObjectURL(file);
                    updateRow(row, url, `${originalKB.toFixed(1)} KB`, 'Original Kept', 'status-skip', file.name);
                    downloadQueue.push({url, name: file.name});
                } else {
                    try {
                        const blob = await smartCompress(file, targetKB, originalKB);
                        const url = URL.createObjectURL(blob);
                        const finalKB = (blob.size / 1024).toFixed(1);
                        const newName = `compressed_${Math.round(finalKB)}kb_${file.name}`;
                        updateRow(row, url, `${finalKB} KB`, 'Compressed', 'status-done', newName);
                        downloadQueue.push({url, name: newName});
                    } catch (e) {
                        updateRow(row, null, '-', 'Error', 'status-skip', '');
                    }
                }
            }
            processBtn.disabled = false;
            if (downloadQueue.length > 0) batchBtn.style.display = 'block';
        };

        async function smartCompress(file, targetKB, originalKB) {
            const bitmap = await createImageBitmap(file);
            let startQ = 0.95;
            if (strategyMode.value === 'manual') {
                startQ = parseFloat(document.getElementById('manualQuality').value) || 0.9;
            } else {
                const ratio = targetKB / originalKB;
                if (ratio > 0.9) startQ = 0.98;
                else if (ratio > 0.7) startQ = 0.92;
                else if (ratio < 0.2) startQ = 0.5;
            }
            let bestBlob = await canvasToBlob(bitmap, startQ, 1.0);
            if (bestBlob.size / 1024 <= targetKB) return bestBlob;

            let low = 0.05, high = startQ;
            for (let i = 0; i < 6; i++) {
                let mid = (low + high) / 2;
                let blob = await canvasToBlob(bitmap, mid, 1.0);
                if (blob.size / 1024 <= targetKB) {
                    bestBlob = blob;
                    low = mid;
                } else {
                    high = mid;
                }
            }
            if (bestBlob.size / 1024 > targetKB * 1.05) {
                let scale = 0.9;
                while (scale > 0.1) {
                    const blob = await canvasToBlob(bitmap, 0.7, scale);
                    if (blob.size / 1024 <= targetKB) {
                        bestBlob = blob;
                        break;
                    }
                    scale -= 0.1;
                }
            }
            return bestBlob;
        }

        function canvasToBlob(bitmap, quality, scale) {
            return new Promise(resolve => {
                const canvas = document.createElement('canvas');
                canvas.width = Math.floor(bitmap.width * scale);
                canvas.height = Math.floor(bitmap.height * scale);
                const ctx = canvas.getContext('2d');
                ctx.imageSmoothingQuality = 'high';
                ctx.drawImage(bitmap, 0, 0, canvas.width, canvas.height);
                canvas.toBlob(b => resolve(b), 'image/jpeg', quality);
            });
        }

        function createRow(file) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${file.name}</td>
                <td>${(file.size / 1024).toFixed(1)} KB</td>
                <td class="res-size">-</td>
                <td><span class="status-badge status-working">Processing...</span></td>
                <td class="res-action">-</td>
            `;
            return tr;
        }

        function updateRow(row, url, sizeText, statusText, statusClass, downloadName) {
            row.querySelector('.res-size').innerText = sizeText;
            const badge = row.querySelector('.status-badge');
            badge.innerText = statusText;
            badge.className = 'status-badge ' + statusClass;
            if (url) {
                const a = document.createElement('a');
                a.href = url;
                a.download = downloadName;
                a.innerText = 'Download';
                a.className = 'download-link';
                row.querySelector('.res-action').innerHTML = '';
                row.querySelector('.res-action').appendChild(a);
            }
        }

        function downloadAll() {
            downloadQueue.forEach((item, i) => {
                setTimeout(() => {
                    const a = document.createElement('a');
                    a.href = item.url;
                    a.download = item.name;
                    a.click();
                }, i * 350);
            });
        }
    </script>
</body>

</html>