<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Auto Image Compressor</title>
    <link rel="icon" href="https://shawkui.github.io/images/favicon-96x96.png?v=M44lzPylqQ" type="image/png">

    <style>
        :root {
            --bg-color: #f5f5f5;
            --text-color: #333;
            --accent-color: #0080ff;
            --accent-hover: #0066cc;
            --accent-active: #004d99;
            --border-color: #ccc;
            --success-color: #28a745;
        }

        body {
            background: var(--bg-color);
            font-family: monospace;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            color: var(--text-color);
        }

        header, footer {
            background: var(--text-color);
            color: white;
            padding: 15px;
            text-align: center;
        }

        header h1 { margin: 0; font-size: 1.8em; }

        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 20px;
        }

        .tool-card {
            background: white;
            width: 100%;
            max-width: 900px;
            padding: 30px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        .config-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px dashed var(--border-color);
        }

        .input-group { display: flex; flex-direction: column; gap: 8px; }
        .input-group label { font-weight: bold; font-size: 0.85em; }

        input[type="number"], select, input[type="file"] {
            padding: 8px;
            font-family: monospace;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            outline: none;
        }

        .btn {
            background: var(--accent-color);
            color: white;
            cursor: pointer;
            font-size: 1.1em;
            font-family: monospace;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            transition: background 0.2s ease-in-out;
            width: 100%;
        }
        .btn:hover { background: var(--accent-hover); }
        .btn:disabled { background: #ccc; cursor: not-allowed; }

        #report {
            margin-top: 30px;
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }
        #report th { text-align: left; border-bottom: 2px solid var(--text-color); padding: 10px; }
        #report td { padding: 10px; border-bottom: 1px solid #eee; }

        .status-badge {
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 0.85em;
        }
        .status-working { background: #fff3cd; color: #856404; }
        .status-done { background: #d4edda; color: #155724; }
        .status-skip { background: #e2e3e5; color: #383d41; }

        .download-link { color: var(--accent-color); text-decoration: none; font-weight: bold; }
        #batch-download-btn { margin-top: 20px; background: var(--success-color); display: none; }

        /* Usage Instructions Section */
        .instructions {
            margin-top: 40px;
            padding: 25px;
            background: #fafafa;
            border: 1px solid #eee;
            border-radius: 8px;
            font-size: 0.9em;
        }
        .instructions h3 { margin-top: 0; color: var(--accent-color); border-bottom: 1px solid #ddd; padding-bottom: 5px; }
        .instructions ul { padding-left: 20px; line-height: 1.7; }
        .instructions li { margin-bottom: 12px; }
        .instructions code { background: #eee; padding: 2px 4px; border-radius: 3px; }

        .note { color: #666; font-size: 0.85em; border-left: 3px solid var(--accent-color); padding-left: 10px; margin-top: 15px; }

        footer a { color: white; text-decoration: underline; }
    </style>
</head>

<body>
    <header>
        <h1>Image Compressor</h1>
    </header>

    <main>
        <div class="tool-card">
            <div class="config-section">
                <div class="input-group">
                    <label>Target Size (KB)</label>
                    <input type="number" id="targetSize" value="512" min="1">
                </div>
                <div class="input-group">
                    <label>Max Iterations</label>
                    <input type="number" id="maxIter" value="10" min="1" max="30" title="Higher = more precise file size">
                </div>
                <div class="input-group">
                    <label>Strategy</label>
                    <select id="strategyMode">
                        <option value="auto">Smart Heuristic</option>
                        <option value="manual">Manual Start</option>
                    </select>
                </div>
                <div class="input-group" id="manualQualityGroup" style="display:none;">
                    <label>Initial Quality</label>
                    <input type="number" id="manualQuality" value="0.95" step="0.05" min="0.1" max="1.0">
                </div>
                <div class="input-group">
                    <label>Upload Images</label>
                    <input type="file" id="fileInput" accept="image/jpeg,image/png" multiple>
                </div>
            </div>

            <button id="processBtn" class="btn">Compress Images</button>

            <table id="report" style="display: none;">
                <thead>
                    <tr>
                        <th>Filename</th>
                        <th>Original</th>
                        <th>Result</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="fileList"></tbody>
            </table>

            <button id="batch-download-btn" class="btn" onclick="downloadAll()">Download All Results</button>

            <div class="instructions">
                <h3>User Instructions</h3>
                <ul>
                    <li><strong>1. Selection:</strong> Choose one or multiple JPG/PNG images. Files are processed locally and never uploaded to any server.</li>
                    <li><strong>2. Set Target:</strong> Enter your maximum file size in <code>KB</code>. The algorithm targets a result as close to this number as possible without exceeding it.</li>
                    <li><strong>3. Max Iterations:</strong>
                        <br>• <code>8-10</code>: Standard speed. Good for general use.
                        <br>• <code>15-20</code>: High precision. Best for hitting exact targets (e.g., getting a 6MB file down to exactly 511KB).
                    </li>
                    <li><strong>4. Strategy:</strong>
                        <br>• <code>Smart Heuristic</code>: Automatically calculates the starting quality based on the original-to-target ratio to save time and detail.
                        <br>• <code>Manual Start</code>: Forces the search to begin at a specific quality level.
                    </li>
                    <li><strong>5. How it Works:</strong> The tool uses a <strong>Double Binary Search</strong>. It first adjusts image quality. If the target size is still not met even at low quality, it performs a second search to find the optimal dimension scale.</li>
                </ul>
                <div class="note">
                    <strong>Privacy & Tech:</strong> 100% Client-Side. Your data privacy is guaranteed as the processing happens entirely within your browser's memory using the Canvas API.
                </div>
            </div>
        </div>
    </main>

    <div class="clustrmap" style="width: 300pt; margin: 20px auto;">
        <h2 style="text-align: center; font-size: 1em;">Visitor Map</h2>
        <script type="text/javascript" id="clustrmaps"
            src="//clustrmaps.com/map_v2.js?d=CgXNcTnngetrL0Ic-6fP1VQ_yyK1aaSZsr1PV-_sVfY&cl=ffffff&w=a"></script>
    </div>

    <footer>
        <p>Image Compressor by Shaokui Wei, <a href="https://shawkui.github.io/">https://shawkui.github.io</a>, 2024</p>
    </footer>

    <script>
        const fileInput = document.getElementById('fileInput');
        const targetSizeInput = document.getElementById('targetSize');
        const maxIterInput = document.getElementById('maxIter');
        const strategyMode = document.getElementById('strategyMode');
        const manualQualityGroup = document.getElementById('manualQualityGroup');
        const processBtn = document.getElementById('processBtn');
        const reportTable = document.getElementById('report');
        const fileList = document.getElementById('fileList');
        const batchBtn = document.getElementById('batch-download-btn');

        let downloadQueue = [];

        strategyMode.onchange = () => {
            manualQualityGroup.style.display = strategyMode.value === 'manual' ? 'flex' : 'none';
        };

        processBtn.onclick = async () => {
            const files = Array.from(fileInput.files);
            const targetKB = parseFloat(targetSizeInput.value);
            const iterations = parseInt(maxIterInput.value) || 10;
            if (!files.length) return alert('Please select images first.');

            fileList.innerHTML = '';
            reportTable.style.display = 'table';
            batchBtn.style.display = 'none';
            downloadQueue = [];
            processBtn.disabled = true;

            for (const file of files) {
                const row = createRow(file);
                fileList.appendChild(row);
                const originalKB = file.size / 1024;

                if (originalKB <= targetKB) {
                    const url = URL.createObjectURL(file);
                    updateRow(row, url, `${originalKB.toFixed(1)} KB`, 'Original Kept', 'status-skip', file.name);
                    downloadQueue.push({url, name: file.name});
                } else {
                    try {
                        const blob = await preciseCompress(file, targetKB, originalKB, iterations);
                        const url = URL.createObjectURL(blob);
                        const finalKB = (blob.size / 1024).toFixed(1);
                        const newName = `compressed_${Math.round(finalKB)}kb_${file.name}`;
                        updateRow(row, url, `${finalKB} KB`, 'Compressed', 'status-done', newName);
                        downloadQueue.push({url, name: newName});
                    } catch (e) {
                        console.error(e);
                        updateRow(row, null, '-', 'Error', 'status-skip', '');
                    }
                }
            }
            processBtn.disabled = false;
            if (downloadQueue.length > 0) batchBtn.style.display = 'block';
        };

        async function preciseCompress(file, targetKB, originalKB, iterations) {
            const bitmap = await createImageBitmap(file);
            let startQ = 0.98;

            if (strategyMode.value === 'manual') {
                startQ = parseFloat(document.getElementById('manualQuality').value) || 0.95;
            } else {
                const ratio = targetKB / originalKB;
                if (ratio > 0.9) startQ = 0.98;
                else if (ratio > 0.7) startQ = 0.95;
                else if (ratio < 0.2) startQ = 0.6;
            }

            let bestBlob = null;
            
            // Phase 1: Quality Binary Search
            let lowQ = 0.01, highQ = startQ;
            for (let i = 0; i < iterations; i++) {
                let midQ = (lowQ + highQ) / 2;
                let blob = await canvasToBlob(bitmap, midQ, 1.0);
                if (blob.size / 1024 <= targetKB) {
                    bestBlob = blob;
                    lowQ = midQ; 
                } else {
                    highQ = midQ;
                }
            }

            // Phase 2: Scaling Binary Search (If lowest quality still exceeds target)
            if (!bestBlob) {
                let lowS = 0.05, highS = 1.0;
                for (let i = 0; i < iterations; i++) {
                    let midS = (lowS + highS) / 2;
                    let blob = await canvasToBlob(bitmap, 0.7, midS); 
                    if (blob.size / 1024 <= targetKB) {
                        bestBlob = blob;
                        lowS = midS; 
                    } else {
                        highS = midS;
                    }
                }
            }
            return bestBlob || await canvasToBlob(bitmap, 0.1, 0.1);
        }

        function canvasToBlob(bitmap, quality, scale) {
            return new Promise(resolve => {
                const canvas = document.createElement('canvas');
                canvas.width = Math.max(1, Math.floor(bitmap.width * scale));
                canvas.height = Math.max(1, Math.floor(bitmap.height * scale));
                const ctx = canvas.getContext('2d');
                ctx.imageSmoothingQuality = 'high';
                ctx.drawImage(bitmap, 0, 0, canvas.width, canvas.height);
                canvas.toBlob(b => resolve(b), 'image/jpeg', quality);
            });
        }

        function createRow(file) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${file.name}</td>
                <td>${(file.size / 1024).toFixed(1)} KB</td>
                <td class="res-size">-</td>
                <td><span class="status-badge status-working">Working...</span></td>
                <td class="res-action">-</td>
            `;
            return tr;
        }

        function updateRow(row, url, sizeText, statusText, statusClass, downloadName) {
            row.querySelector('.res-size').innerText = sizeText;
            const badge = row.querySelector('.status-badge');
            badge.innerText = statusText;
            badge.className = 'status-badge ' + statusClass;
            if (url) {
                const a = document.createElement('a');
                a.href = url;
                a.download = downloadName;
                a.innerText = 'Download';
                a.className = 'download-link';
                row.querySelector('.res-action').innerHTML = '';
                row.querySelector('.res-action').appendChild(a);
            }
        }

        function downloadAll() {
            downloadQueue.forEach((item, i) => {
                setTimeout(() => {
                    const a = document.createElement('a');
                    a.href = item.url;
                    a.download = item.name;
                    a.click();
                }, i * 350);
            });
        }
    </script>
</body>

</html>
